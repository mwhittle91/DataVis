<!DOCTYPE>
<HTML>
	<HEAD>
		<TITLE>
			Data Vis with JavaScript
		</TITLE>
		<LINK REL="stylesheet" HREF="css/style.css" />
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
		<script type="text/javascript" src="js/code.js"></script>
		<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
	</HEAD>
	<BODY ONLOAD = "initmap()">
		<center>

		<DIV id = "container">
			<DIV id = "text">
				<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
				</HEAD>
				<BODY ONLOAD = "initmap()">
					<h1>Data Vis with JavaScript</h1>
					<BR>
					<h2>Matthew Whittle</h2>
					<BR>
					<p>
						Take a quick look at <a title="this website" target="_blank" href="http://www.roadsafetyweek.org.uk/drivelessmap/">this website</a>. This is a map that I created for Road Safety Week 2015 in collaboration with a road safety charity called 
						<a title="Brake" href="http://www.brake.org.uk/">Brake</a>.They came to me via my supervisor has they wanted some maps to provide evidence in the relationship between active transport (cycling and walking), car use and
						deaths due to air quality. Rather than producing a static map I decided that a more interactive tool would be best as people tend to look at their home environment rather than the UK as a whole.
					</p>
					<p> This interactive tutorial relies on a great example provided by leaflet, after the tutorial go and have a look at
					<a title="this website" target="_blank" href="http://leafletjs.com/examples/choropleth.html">this</a> example and the other demonstrations to help get a sense of what you  can do with the leaflet plugin.
					a great extenstion is also availible for leaflet through mapbox, if you enjoyed this tutorial then I would suggest having a look at 
					<a title="this website" target="_blank" href="https://www.mapbox.com/">mapbox</a> as it adds on a lot of extra functionality  to leaflet.
					</p>
					
					<p>
						The map uses a mixture of JavaScript, Cascading Style Sheets (CSS) and HTML as well as using Leaflet and AJAX JavaScript plugins to help with the functionality. In this practical I will guide you through how to:
						<BR>
						<BR> 1) load in a leaflet map
						<BR> 2) Create a geoJson layer using QGIS
						<BR> 3) Load a geoJson layer into the map
						<BR> 4) Manipulate the geoJson for hover events
						<BR> 5) Create a panel to display more info 
						<BR>
					</p>
					<BR>
					<h2>Step 1. Creating a Leaflet map</h2>
					<BR>
					<p>
						Leaflet is a JavaScript plugin in for web mapping. We are going to use Leaflet instead of Google Maps API because Leaflet is open-source (free to use!) and lightweight (only 33KB).
					</p>
					<BR>
					<BR>

					<div id="map"></div>
		
					<BR>
					<p>
						In order to create a map like the one above you first need to create a file called WWW in your M drive. After this open Notepad ++ and create a file named index.html (ensure you change the file type to html and not left as .txt in the dropdown box). Now
						Lets test it - Copy and paste the following code into index.html.
					</p>
					<BR>
					<pre>
	<code>
&lt!DOCTYPE&gt
 &ltHTML&gt
  &ltHEAD&gt

   &ltTITLE&gt
    Data Vis with JavaScript
   &lt/TITLE&gt

   &lt/HEAD&gt
  &ltBODY&gt

  Hello, World! 

  &lt/BODY&gt
 &lt/HTML&gt
	</code>
</pre>
					<BR>
					<p>
						This should create a web page with the title <a title="Hello, World!" target="_blank" href="https://en.wikipedia.org/wiki/%22Hello,_World!%22_program">Hello, World!</a>
						on your screen when you visit http://www.personal.leeds.ac.uk/~'YOUR USERNAME'/WWW/index.html. Hello, World! is often used computer to test whether certain parts of the code are working correctly, have a look 
						at the wiki page linked. 
						<BR>
						<BR>
						<a title="Congratulations! You've just made a web page! " target="_blank" href="https://s-media-cache-ak0.pinimg.com/736x/8a/05/6b/8a056b1008905a8ffcbd492f0483feeb.jpg">Congratulations! You've just made a web page! </a>
						Now lets start adding in the leaflet map. First you will have tell the web page to load the leaflet plugin and associated css along with creating a DIV element to hold the Leaflet map.
						To do this copy and paste the following code into the head section of your index.html file 
					</p>
					<BR>
					<pre>
<code>
&lt!DOCTYPE&gt
&ltHTML&gt
 &ltHEAD&gt
 
  &ltTITLE&gt
   Data Vis with JavaScript
  &lt/TITLE&gt
 
  &ltscript src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"&gt&lt/script&gt
  &ltlink rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css"&gt
  
 &lt/HEAD&gt
 &ltBODY&gt
 
  Hello, World! 
  
  &ltDIV id = "map"&gt&lt/DIV&gt
  
 &lt/BODY&gt
&lt/HTML&gt
</code>
					</pre>
					<BR>
					<p>
						Next you will have to create a JavaScript function to in order to create the map. Go to Notepad++ and create a JavaScript file called code. Now copy the code below into your new code.js file
					</p>
					<BR>
					<pre>
<code>



function initmap() {
var map = L.map('map').setView([51.505, -0.09], 13);

L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
attribution: '&copy; &lta href="http://osm.org/copyright"&gtOpenStreetMap&lt/a&gt contributors'
}).addTo(map);

L.marker([51.5, -0.09]).addTo(map)
.bindPopup('A pretty CSS3 popup.&ltbr&gt Easily customizable.')
.openPopup();
}
</code>
					</pre>
					<p>
						Next you will have to create a JavaScript function to in order to create the map. Go to Notepad++ and create a JavaScript file called code. Now copy the code below into your new code.js file
					</p>
					<BR>
					<p>
						In order to display the map we need to tell the browser what size we want the map, this is done using CSS. In Notepad++ create a file called style.css and the paste in the code below. 
					</p>
					<BR>
					<pre>
<code>
#map {
  height: 100%;
  width: 100%;
}
</code>
					</pre>
					<p>
						Finally we need to tell the computer where to find the JavaScript and CSS in order to display the map, this is done in the same as loading in the leaflet plugin. Just copy and paste the code below into the 
						head section on index.html,ensure you have the correct file path, if the style.css and code.js files are in the same file as index.html then no file path is needed, just type the file name. 
					</p>
					<BR>
					<pre>
<code>
&ltLINK REL="stylesheet" HREF="style.css" /&gt
&ltscript type="text/javascript" src="code.js"&gt&lt/script&gt
</code>
					</pre>
					<BR>
					<p>
						Well done! On your website you should now have a full screen map which you can pan and zoom around. 
					</p>
					<BR>
					<h2>Step 2. Making the data in R</h2>
					<BR>
					<p>
						In order to display data on our web page we first need to create some data. To do this we will join 2 datasets together, one data set has our aggregated data in and another one has spatial information. These
						2 files will be combined using R and saved as a geojson file which can then be read into our web page. 
						<BR>
						<BR>
						Download the files  <a href="http://www.personal.leeds.ac.uk/~gy14mw/dataVis/data/data.zip" >here</a>
						<BR>
						<BR>
						In these files we have 2 data sources but many files. This is because out spatial data is in the form of a shapefile, these files are compromised of several files and you must keep all of the associated together in the same folder
						otherwise the data will become corrupt and unusable. The other file is a .csv file, open this up in excel and have a look at the data. 
						<BR>
						<BR>
						Open RStudio (if you are on your own laptop please download it <a title="here" href="https://www.rstudio.com/products/rstudio/download/">here</a>). RStudio is a free open source IDE for the R programming language, it makes
						programming in R far easier as it has inbuilt debugging and visualisation tools. 
						<BR> 
						<BR>
						In R we are going to do the following: 
						<BR>
						<BR> 1) read in the shapefile
						<BR> 2) Read in the .csv
						<BR> 3) Join the 2 files together
						<BR> 4) save the output as a geojson 
						<BR> 5) Do some simple querying (we might as well while we are here!)
						<BR>
						<BR>
					</p>
					<p>
						The following code carries out steps 1 2 3 and in the sequence above. Copy and paste the code below (edit the filepath and filename sections)
						into RStudio to run the code highlight the code and press control and enter. You should end up with a plot of the UK and a 
						variable called data in the objects list, click on this and you should see the data magically appear in R. The next line joins UK to data via
						the common column of data in ZONE_LABEL. The following line tells the computer to save the newly created merged file as a geojson. 
						<BR>
						<BR> 
						See coding isn't difficult after all! In the space of 4 lines of code you read in 2 files, joined them up and read the data out in a new format.
					</p>
					<BR>
					<pre>
<code>
install.packages("rgdal")
library(rgdal)

UK <- readOGR(dsn = 'C:/Users/Matt/Downloads/data', layer = 'UK_LA')

plot(UK)

data <- read.csv(file="C:/Users/Matt/Downloads/data/UK_data.csv ", header=TRUE, sep=",")

UK_Data <- merge(x = UK, y = data, by = "ZONE_CODE", all = TRUE)

writeOGR(UK_Data, 'C:/Users/Matt/Downloads/data/UK_Data.geojson', layer="UK_Data", driver="GeoJSON")
</code>
					</pre>
					<BR>
					<p>
						While we are in R we'll look at some simple features. Copy and paste the code below to see how we can use the R programming language to query 
						data and produce other visualisations such as graphs. 
						<BR>
						<BR>
						In the example below we create a quick map from some subsets. The map finds areas where the inactivity rate is > 60 % and colours these red,
						The next subset looks at two variables and finds where the inactivity is above 65% and the percentage of people who drive to work is above 45%, 
						these areas are then coloured blue. 
						<BR>
						<BR>
					</p>
					<pre>
<code>
summary(UK_Data)

plot(UK_Data, col = "grey" )

selection <- subset(UK_Data, data_Inact > 60)

plot(selection, col ="red", add =TRUE)

multiselection <- subset(UK_Data, data_Inact > 65 & data_Drive > 45)

plot(multiselection, col= "blue", add = TRUE)
</code>
					</pre>
					<p>
						<BR>
						<BR>
						In the next example we will make a quick scatter plot using the plotly library. Try playing around with the x and y data to produce some interesting graphs, also try to create a subset
						so the graph excludes Scottish and Welsh data as we don't have all the data for these regions. Have a look at the plotly library and have a go at producing 
						some other graphs. 
						<BR>
						<BR>
					</p>
					<pre>
<code>
install.packages("plotly")
library(plotly)
plot_ly(data = data, x = data_Inact, y = data_CO2, mode = "markers")
</code>
					</pre>
					<BR>
					<BR>
					<h2>Step 3. Alternitive to R - QGIS. </h2>
					<BR>
					<p>
						If coding scares you a bit and you'd prefer to see what you are doing then QGIS is the best way forward. QGIS is a GIS software package, again open source (starting to see a trend?), that allows
						the mapping of spatial data and geospatial queries.
						
						To create the data download the source data <a href="http://www.personal.leeds.ac.uk/~gy14mw/dataVis/data/data.zip" >here</a>. Open up QGIS and load in the shapefile from the source data by clicking
						this button. Navigate to the file UK_LA.shp and open it. You should now have an image of the UK on your screen.
						<BR>
						<BR>
							<img src="images/qgis1.png" alt="qgis1" style="width:1000px;height:500px;">
						<BR>
						<BR>
						Next we will load in the data. To do this click on the comma that you can see on the right hand pane and load in the data, ensure that you choose the UK_data.csv, you should get a similar screen to
						below. Hint - this data has no geometry...
						<BR>
						<BR>
							<img src="images/qgis2.png" alt="qgis2" style="width:1000px;height:500px;">
						<BR>
						<BR>
						We now need to join the two layers together. Right click on the UK_LA layer and select properties, navigate to the join section on the new pane. Your screen should look like this. Ensure that you  
						are basing your join on the UK_Data layer via the common column name ZONE_CODE. Don't forget to apply the join on the properties window pane. 
						<BR>
						<BR>
							<img src="images/qgis3.png" alt="qgis2" style="width:1000px;height:500px;">
						<BR>
						<BR>
						To test if the join has worked right click on the UK_LA layer and select attribute table, you should see that the contents of UK_Data is now attached to UK_LA. If this has worked then right click on 
						the UK_LA layer and click save as. You should save this as a geojson layer and select the coordinate projection as WGS84 NOT British National Grid. I'm going to call my file UK_Data.geojson you 
						might also want too...
						<BR>
						<BR>
						Well done! You've mastered QGIS! You can now put Cartographer on your CV!
					</p>
					<BR>
					<BR>
					<h2>Step 4. Loading your geojson layer into the webpage </h2>
					<p>
					<BR>
					<BR>
					Open the geojson layer that you created in step 3 or 2 in notepad++. Here you want to create a variable that can be called in to JavaScript function.  To do this type "var data =" before the geojson data
					and save the file as data.js, ensure you change the filetype to javascript. Next include a link in the head of the html like the line below. 
					<BR>
					<BR>
					<pre>
<code>
&ltscript type="text/javascript" src="data.js"&gt&lt/script&gt
</code>
					</pre>
					<p>
					<BR>
					<BR> In order to read in the data you need to add the new variable which stores the geojson data to the Leaflet map. In order to do this paste the code below in code.js
					<BR>
					<BR>
					<pre>
<code>
L.geoJson(data).addTo(map);
</code>
					</pre>
					<p>
					<BR>
					<BR> Now go onto the internet and see if the geojson is visible on the webpage, you should have the a blue UK split into local authorities.
					<BR>
					<BR>In order to make the map colourful you can use the code below to create a cloropleth map (remove the previous line of code), where the colour of the map represents the value of one of the variables in the data. This code will
					draw the percentage of people who drive to work for each local authority. Try finding the piece of code that points to this data and changing the variable which is being mapped. 
					<BR>
					<BR>
					<pre>
<code>
function getColor(d) {
    return d > 50 	 ? '#800026' :
           d > 40 	 ? '#BD0026' :
           d > 35 	 ? '#E31A1C' :
           d > 30 	 ? '#FC4E2A' :
           d > 25    	 ? '#FD8D3C' :
           d > 20        ? '#FEB24C' :
           d > 10        ? '#FED976' :
			    #FFEDA0';
}

function style(feature) {
    return {
        fillColor: getColor(feature.properties.data_Drive),
        weight: 2,
        opacity: 1,
        color: 'white',
        dashArray: '3',
        fillOpacity: 0.7
    };
}

L.geoJson(data, {style: style}).addTo(map);
</code>
					</pre>
					<BR>
					<BR>
					<h2>Step 5. Enable hover events on your geojson </h2>
					<p>
					<BR>
					<BR> Now we will add some interactive functions to our map. The code below will highlight whichever local authority that you are hovering over. Copy and paste this below your previous code.
					<BR>
					<BR>
					<pre>
<code>
function highlightFeature(e) {
    var layer = e.target;

    layer.setStyle({
        weight: 5,
        color: '#666',
        dashArray: '',
        fillOpacity: 0.7
    });

    if (!L.Browser.ie && !L.Browser.opera) {
        layer.bringToFront();
    }
}

function resetHighlight(e) {
    geojson.resetStyle(e.target);
}
</code>
					</pre>
					<p>
					<BR> 
					<BR> 
					You may have noticed some unusaul behaviour after using the last piece of code. That is becuase the geojson is not accessible yet through a variable. Fix this by creating a variable called geojson
					before the listeners that you have just created. 
					<BR> 
					<BR> 
					Lets add some extra functions. Copy and paste the code below and try to find out what it is doing. HINT you will need to replace a previous line of code. 
					<BR> 
					<BR>
					<pre>
<code>
function zoomToFeature(e) {
    map.fitBounds(e.target.getBounds());
}

function onEachFeature(feature, layer) {
    layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: zoomToFeature
    });
}

geojson = L.geoJson(statesData, {
    style: style,
    onEachFeature: onEachFeature
}).addTo(map);
</code>
					</pre>
					<h2>Step 6. Create a panel to display more info </h2>
					<p>
					<BR>
					<BR> Copy and paste the following code into you code.js, this will create 
					<pre>
					<BR>
					<BR>
<code>
var info = L.control();

info.update = function (props) {
    this._div.innerHTML = 
	
		  (props ?
        '&ltb>&lth1>' + props.ZONE_LABEL + '&lt/h1>&lt/b>'
        : '-') +
	
	'&lth4>CO2  emissions&lt/h4>' +  (props ?
        '&lth3>&ltb>' + props.data_CO2 + ' tonnes&lt/h3>&lt/b>'
        : '-') +
		
	'&lth4>Drive to work&lt/h4>' + ( props ?
        '&lth3>&ltb>' + props.data_Drive + ' %&lt/h3>&lt/b>'
        : '-' ) +	
	
	'&lth4>Cycle to work&lt/h4>' + ( props ?
        '&lth3>&ltb>' + props.data_Cycle + ' %&lt/h3>&lt/b>'
        : '-' ) +
	
	'&lth4>Inactive&lt/h4>' + ( props ?
        '&lth3>&ltb>' + props.data_Inact + ' %&lt/h3>&lt/b>'
        : '-' ) +
				
};

info.addTo(map);
</code>
					</pre>
					<p>
					<BR>
					<BR> We also need to update the control when the the cursor is hovered over a local authority, so we need to change the hover listeners, add the following lines of code to the listeners. 
					<pre>
					<BR>
					<BR>
<code>
function highlightFeature(e) {
    ...
    info.update(layer.feature.properties);
}

function resetHighlight(e) {
    ...
    info.update();
}
</code>
					</pre>
					<p>
					<BR>
					<BR> The control box is in need of some styling, copy and paste this code into you css file. 
					<pre>
					<BR>
					<BR>
<code>
.info {
    padding: 6px 8px;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background: white;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
}
.info h4 {
    margin: 0 0 5px;
    color: #777;
}


</code>
					</pre>
					<p>
					<BR>
					<BR> Congratulations! you've created your first interactive leaflet map! Have a play around with the site and try adding in things and changing bits of the site.  
					<BR>
					<BR>
					</p>
			</DIV>
		</DIV>
	</BODY>
</HTML>































